#!/bin/bash

set -e

# This bash script is used to create the Mtb multiple alignments per lineage
# The first step consists in creating text files with all snippy consensus file names per lineage group
# This forth step keeps only the strict core-genome in multiple alignments, to reduce the size of alignments
# NOTE: the reference genome is also added to the mfa, as it's an ancestral version of H37rv, it can also be used as outgroup to root each tree
# NOTE: see script create_bed_file_core_genes_on_reference.mtbc.sh.txt to see how the strict core genome (of 2068812 bp) was derived

# cd /Users/francesccoll/fellowship/2.projects/67.mtb_within_host/tb-profiler
# cat mtb_wh_extended.v1.tb-profiler.num_strain.csv | awk -F'\t' '{ print $3}' | grep -v "alignment" | sort | uniq > lineage_alignment_groups.txt

dir="/nfs/users/nfs_f/fc4/lustre_scratch118/67.mtb_within_host/phylogeny2/";
aln_groups_file=$dir"lineage_alignment_groups.txt";
core_genome_bed="/Users/francesccoll/fellowship/2.projects/49.gwas_power_calculations/mtbc/panaroo/H37Rv.mtbc_strict_core_genome.one_copy.bed";
core_genome_tab="/Users/francesccoll/fellowship/2.projects/49.gwas_power_calculations/mtbc/panaroo/H37Rv.mtbc_strict_core_genome.one_copy.tab";
# cat $core_genome_bed | awk -F'\t' '{ print "FT\tcore_gene\t"$2".."$3 }' > $core_genome_tab

aln_groups=`cat $aln_groups_file | awk -F'\t' '{ print $1}'`;

cd $con_dir

for aln_group in $aln_groups
do
	echo $aln_group
	consensus_files=$dir$aln_group".consensus_files.txt";
	aln_group_mfa1=$dir"mtb_wh_extended.v1."$aln_group".masked.mfa";
	aln_group_mfa2=$dir"mtb_wh_extended.v1."$aln_group".masked.core.mfa";
	bsub -q normal -G team346 -J $aln_group -o $aln_group".core.out" -R "select[mem > 100000] rusage[mem= 100000]" -M 100000 "python2.7 ~/bin/remove_blocks_from_aln.py -a $aln_group_mfa1 -o $aln_group_mfa2 -t $core_genome_tab -c"
done
